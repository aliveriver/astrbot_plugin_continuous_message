# AstrBot 消息防抖动插件

## 简介

消息防抖动插件可以将用户短时间内发送的多条私聊消息合并成一条发送给大语言模型（LLM），避免频繁触发AI回复，提升用户体验。

## 功能特性

**智能消息合并**：自动将用户短时间内发送的多条消息合并成一条  
**指令智能过滤**：自动识别并跳过指令消息（如 `/help`、`#image` 等）  
**私聊模式**：仅在私聊工作，群聊目前有些越权问题  
**多媒体支持**：自动识别图片并与文本一起传递给 LLM  
**会话人格支持**：自动使用当前会话配置的人格，支持多用户不同人格  
**对话历史维护**：自动维护和更新对话历史记录  
**灵活可配置**：支持自定义防抖时间、指令前缀等参数  
**低优先级设计**：不干扰其他插件的正常运行  

## 使用场景

- 用户输入较长内容时，习惯分成多条消息发送
- 用户打字速度较慢，希望等待输入完整后再获得AI回复
- 用户发送多张图片和文字说明，希望一起处理
- 减少不必要的LLM调用，节省API费用

## 安装

### 通过AstrBot直接安装

在插件市场直接点击安装


### 直接安装

1. 将插件文件放置到 AstrBot 的插件目录中：
   ```
   data/plugins/astrbot_plugin_continuous_message/
   ```

2. 重启 AstrBot 或在管理面板中重载插件

## 配置说明

插件支持以下配置项（可在 AstrBot 管理面板中配置）：


### enable（启用功能）
- **类型**：布尔值
- **默认值**：`true`
- **说明**：是否启用消息防抖动功能
- **提示**：关闭后插件将不会拦截和合并消息

### debounce_time（防抖时间）
- **类型**：浮点数（秒）
- **默认值**：`2.0`
- **说明**：用户停止发送消息后，等待多久将消息合并发送给LLM
- **建议值**：
  - **1.5 秒**：快速响应，适合简短对话
  - **2.0 秒**：平衡响应速度与合并效果（推荐）
  - **3.0 秒**：最大化合并效果，适合慢速打字

### command_prefixes（指令前缀列表）
- **类型**：列表
- **默认值**：`["/"]`
- **说明**：以这些前缀开头的消息会被识别为指令，不会被合并
- **示例**：`["/", "#", "＃", "!"]`
- **注意**：
  - 指令会立即执行，不参与防抖
  - 期间收到指令会结束当前防抖会话

### merge_separator（消息分隔符）
- **类型**：字符串
- **默认值**：`"\n"`（换行符）
- **说明**：多条消息合并时使用的分隔符
- **其他选项**：
  - `" "`（空格）：适合短句合并
  - `"。"`（句号）：适合中文句子
  - 自定义任意字符串

## 工作原理

### 防抖流程图

```
用户发送消息1 ──┐
                 │ 加入缓冲区
用户发送消息2 ──┤ 重置计时器
                 │ 继续等待...
用户发送消息3 ──┤ 重置计时器
                 │
用户停止发送 ────┘
                 │
              等待 2秒
                 │
                 ▼
            合并所有消息
                 │
                 ▼
       获取会话人格 + 对话历史
                 │
                 ▼
           调用 LLM API
                 │
                 ▼
           返回 AI 回复
```

### 详细步骤

1. **消息拦截**：用户发送第一条非指令消息时，插件拦截并开始防抖
2. **缓冲收集**：后续消息（含图片）持续加入缓冲区，每次重置计时器
3. **指令中断**：如果期间收到指令消息，立即结束防抖会话
4. **超时合并**：防抖时间结束后，将所有文本消息用分隔符合并
5. **上下文准备**：
   - 获取当前会话配置的人格设定
   - 获取对话历史记录
   - 收集所有图片 URL
6. **LLM 调用**：将合并的文本、图片、人格、历史一起发送给 LLM
7. **回复返回**：AI 回复通过 AstrBot 标准流程返回给用户
8. **历史更新**：自动更新对话历史，保持上下文连贯

## 使用示例

### 场景1：普通文本消息合并

**用户操作**：
```
[00:00] 用户：今天天气怎么样
[00:01] 用户：我想去爬山
[00:02] 用户：需要准备什么
[00:04] （停止发送，防抖开始计时）
```

**插件行为**：
- 等待 2 秒后，将三条消息合并为：
```
今天天气怎么样
我想去爬山
需要准备什么
```
- 发送给 LLM，获取完整回复

**Bot 回复**（示例）：
```
根据您的问题，我来帮您分析：
1. 今天天气晴朗，适合爬山
2. 建议准备：运动鞋、水、防晒霜、小零食
3. 注意安全，建议结伴同行
```

### 场景2：图片 + 文字混合消息

**用户操作**：
```
[00:00] 用户：看这张图
[00:01] 用户：[发送图片]
[00:02] 用户：这是什么品种的猫
```

**插件行为**：
- 识别图片 URL
- 合并文本：`看这张图\n[图片]\n这是什么品种的猫`
- 将文本 + 图片一起发送给 LLM

**Bot 回复**（示例）：
```
从图片来看，这是一只英国短毛猫（蓝猫）。特征包括：
- 圆润的脸型
- 厚实的被毛
- 典型的灰蓝色毛色
非常可爱的品种！
```

### 场景3：指令消息中断防抖

**用户操作**：
```
[00:00] 用户：你好
[00:01] 用户：/help
```

**插件行为**：
- 第一条"你好"进入缓冲区
- 第二条 `/help` 被识别为指令，立即执行，结束防抖
- 2秒后"你好"单独发送给 LLM


## 注意事项

### ⚙️ 使用建议
4. **防抖时间调整**：根据实际使用场景调整 `debounce_time`
   - 手机用户打字较慢：建议 2.5 - 3.0 秒
   - 电脑用户打字较快：建议 1.5 - 2.0 秒
   - 希望快速响应：建议 1.0 - 1.5 秒
5. **指令前缀配置**：确保包含所有常用指令的前缀，避免指令被误合并
6. **插件优先级**：插件使用低优先级（priority=50），不会干扰其他插件

### 🎯 功能特性
7. **指令立即执行**：任何指令消息会立即执行并结束当前防抖会话
8. **图片自动识别**：支持多张图片，自动提取 URL 并传递给 LLM
9. **对话历史维护**：自动维护对话历史，确保上下文连贯
11. **日志实时输出**：所有关键步骤都会输出到控制台，前缀为 `[消息防抖动]`



## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！

### 贡献指南
- 发现 Bug？请提交详细的错误日志
- 有新想法？欢迎提交 Feature Request
- 改进文档？欢迎提交 PR


## 致谢

感谢 AstrBot 项目提供强大的插件系统和完善的 API！

---

*让每一次对话都更加流畅自然*
